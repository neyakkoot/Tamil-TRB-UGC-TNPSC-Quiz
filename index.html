<script>
/* ------------------------------
  Enhanced quiz list + inactivity + Unicode-fix script
  Replace your existing inline script with this (or place it BEFORE quiz-loader.js)
-------------------------------*/

(function () {
  // CONFIG
  const QUIZ_INDEX_URL = 'quizzes/index.json'; // (optional) server-side index if you maintain one
  const LOCAL_STORAGE_QUIZ_LIST = 'quizList'; // optional fallback location where uploader may write list
  const INACTIVITY_MINUTES = 4;

  // State
  let inactivityTimer = null;
  let timerInterval = null;
  let totalSeconds = 0;

  // DOM refs
  const loginContainer = document.getElementById('login-container');
  const appContainer = document.getElementById('app-container');
  const loginBtn = document.getElementById('login-btn');
  const usernameInput = document.getElementById('username-input');
  const logoutBtn = document.getElementById('logout-btn');
  const welcomeMessageEl = document.getElementById('welcome-message');
  const historyTableBodyEl = document.getElementById('history-table-body');
  const noHistoryMsgEl = document.getElementById('no-history-msg');
  const statTotalAttemptsEl = document.getElementById('stat-total-attempts');
  const statAvgScoreEl = document.getElementById('stat-avg-score');
  const quizSelect = document.getElementById('quizSelect');

  // --- Utilities ---

  // sanitize titles: remove Unicode replacement chars and trim
  function sanitizeTitle(t) {
    if (!t && t !== '') return '';
    // remove U+FFFD replacement char and trim whitespace
    return String(t).replace(/\uFFFD/g, '').trim();
  }

  // robust JSON fetch with fallback
  async function tryFetchJson(url) {
    try {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('Network response not ok');
      return await res.json();
    } catch (e) {
      console.warn('fetch failed:', url, e);
      return null;
    }
  }

  // populate <select> with quiz entries (list: array of {file, title})
  function populateQuizSelect(list) {
    // ensure valid array
    if (!Array.isArray(list)) list = [];
    // clear existing options (but keep placeholder)
    const placeholderIndex = 0;
    // remove all non-placeholder children
    [...quizSelect.options].forEach((opt, idx) => {
      if (idx !== placeholderIndex) opt.remove();
    });

    // append items
    list.forEach(item => {
      const file = item.file || item.path || item.id;
      let title = sanitizeTitle(item.title || item.name || file);
      if (!file) return; // skip bad entries
      const opt = document.createElement('option');
      opt.value = file;
      opt.textContent = title;
      opt.dataset.raw = JSON.stringify(item);
      quizSelect.appendChild(opt);
    });

    // Make sure the select is visible and enabled
    quizSelect.disabled = false;
    quizSelect.style.display = '';
  }

  // load quizzes from multiple possible sources (index.json -> localStorage -> embedded fallback)
  async function loadQuizList() {
    // Try 1: server-side index file (recommended)
    let list = await tryFetchJson(QUIZ_INDEX_URL);
    if (Array.isArray(list) && list.length) {
      console.log('Loaded quiz list from', QUIZ_INDEX_URL);
      populateQuizSelect(list);
      return list;
    }

    // Try 2: localStorage (maybe uploader saved the index there)
    try {
      const stored = localStorage.getItem(LOCAL_STORAGE_QUIZ_LIST);
      if (stored) {
        const parsed = JSON.parse(stored);
        if (Array.isArray(parsed) && parsed.length) {
          console.log('Loaded quiz list from localStorage');
          populateQuizSelect(parsed);
          return parsed;
        }
      }
    } catch (e) {
      console.warn('localStorage quiz list parse failed', e);
    }

    // Try 3: try scanning a local folder listing (fetch each known filename may 404 ‚Äî not ideal)
    // SKIPPED: not reliable client-side without a server index.

    // Fallback: use embedded default list (useful when you paste or supply array)
    const fallback = [
      {"file":"Language_Origin_Quiz 2.json","title":"‡Æö‡Æø‡Æµ‡Æ™‡ØÜ‡Æ∞‡ØÅ‡ÆÆ‡Ææ‡Æ©‡Øç, ‡Æ§‡ØÜ‡Æ©‡Øç‡ÆÆ‡Øä‡Æ¥‡Æø ‚Äì ‡ÆÆ‡Øä‡Æ¥‡Æø‡Æ§‡Øç ‡Æ§‡Øã‡Æ±‡Øç‡Æ±‡ÆÆ‡Øç"},
      {"file":"Language_Origin_Quiz.json","title":"‡ÆÆ‡Øä‡Æ¥‡Æø‡ÆØ‡Æø‡Æ©‡Øç ‡Æ§‡Øã‡Æ±‡Øç‡Æ±‡ÆÆ‡Øç ‚Äì ‡ÆÜ‡ÆØ‡Øç‡Æµ‡ØÅ"},
      {"file":"Tamil_Language_Literture-quiz_Archeaology-30.json","title":"‡Æï‡Æ≤‡Øç‡Æ≤‡Æø‡Æ≤‡Øç ‡Æ™‡Øä‡Æ±‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡Æï‡Æ≤‡Øç‡Æµ‡ØÜ‡Æü‡Øç‡Æü‡ØÅ‡Æï‡Æ≥‡Øç"}
      // <-- add more fallback items as needed
    ];
    console.log('Using fallback quiz list');
    populateQuizSelect(fallback);
    return fallback;
  }

  // Called when user selects a quiz from dropdown
  async function handleQuizSelect(e) {
    resetInactivityTimer(); // user interacted
    const file = e.target.value;
    if (!file) return;

    // Try: if external loader provides startQuizFromFile() use it
    if (typeof window.startQuizFromFile === 'function') {
      try {
        window.startQuizFromFile(file); // your external loader should implement this
        return;
      } catch (err) {
        console.warn('startQuizFromFile error', err);
      }
    }

    // Else try to fetch the file and hand data to loader
    try {
      const data = await tryFetchJson(`quizzes/${encodeURIComponent(file)}`);
      if (data) {
        // If loader exposes loadQuizFromData(data, title) use that
        const title = sanitizeTitle((e.target.selectedOptions[0] && e.target.selectedOptions[0].textContent) || file);
        if (typeof window.loadQuizFromData === 'function') {
          window.loadQuizFromData(data, title);
        } else {
          // fallback: expose globally and dispatch an event so other script can pick it up
          window.currentQuizData = { data, title, file };
          document.dispatchEvent(new CustomEvent('quiz-data-loaded', { detail: window.currentQuizData }));
          console.log('Dispatched quiz-data-loaded event for', file);
        }

        // Start quiz timer (if your loader doesn't do it)
        if (typeof window.getQuestionCountFromData === 'function') {
          const qCount = window.getQuestionCountFromData(data);
          if (qCount) startQuizTimer(qCount);
        } else if (Array.isArray(data.questions)) {
          startQuizTimer(data.questions.length);
        }
      } else {
        alert('‡Æá‡Æ®‡Øç‡Æ§ ‡Æµ‡Æø‡Æ©‡Ææ‡Æü‡Æø-‡Æµ‡Æø‡Æ©‡Ææ ‡Æï‡Øã‡Æ™‡Øç‡Æ™‡Øà ‡Æè‡Æ±‡Øç‡Æ± ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà: ' + file);
      }
    } catch (err) {
      console.error('Error loading quiz file', err);
      alert('‡Æµ‡Æø‡Æ©‡Ææ‡Æü‡Æø-‡Æµ‡Æø‡Æ©‡Ææ ‡Æï‡Øã‡Æ™‡Øç‡Æ™‡Øà ‡Æè‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡Æ™‡Æø‡Æ¥‡Øà ‡Æè‡Æ±‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ. Console-‡Æê‡Æ™‡Øç ‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.');
    }
  }

  // Save result (unchanged from your original logic)
  function saveQuizResult(title, score, total, percentage) {
    let history = JSON.parse(localStorage.getItem('quizHistory')) || [];
    const newResult = {
      title: title,
      score: score,
      total: total,
      percentage: percentage,
      date: new Date().toLocaleString('ta-IN')
    };
    history.unshift(newResult);
    localStorage.setItem('quizHistory', JSON.stringify(history));
    loadDashboardData();
  }

  // Load dashboard (kept same but robust)
  function loadDashboardData() {
    let history = JSON.parse(localStorage.getItem('quizHistory')) || [];
    historyTableBodyEl.innerHTML = "";
    if (history.length === 0) {
      noHistoryMsgEl.style.display = "block";
      historyTableBodyEl.style.display = "none";
      statTotalAttemptsEl.textContent = "0";
      statAvgScoreEl.textContent = "0%";
    } else {
      noHistoryMsgEl.style.display = "none";
      historyTableBodyEl.style.display = "";
      let totalPercentage = 0;
      history.forEach(result => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${result.date}</td>
          <td>${result.title}</td>
          <td><strong>${result.score} / ${result.total}</strong> (${result.percentage}%)</td>
        `;
        historyTableBodyEl.appendChild(row);
        totalPercentage += result.percentage;
      });
      const avgScore = Math.round(totalPercentage / history.length);
      statTotalAttemptsEl.textContent = history.length;
      statAvgScoreEl.textContent = `${avgScore}%`;
    }
  }

  // LOGIN / LOGOUT (kept behavior)
  function checkLogin() {
    const user = localStorage.getItem('quizUser');
    if (user) showApp();
    else showLogin();
  }

  function showLogin() {
    loginContainer.classList.remove('hidden');
    appContainer.classList.add('hidden');
  }
  function showApp() {
    loginContainer.classList.add('hidden');
    appContainer.classList.remove('hidden');
    const userData = JSON.parse(localStorage.getItem('quizUser'));
    welcomeMessageEl.textContent = `üìà ‡Æé‡Æ©‡Øç ‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø‡Æï‡Æ≥‡Øç (‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç, ${userData.name}!)`;
    loadDashboardData();
  }

  // Timer / inactivity utilities (kept but safe-guarded)
  function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
      alert(`‡Æ®‡ØÄ‡Æô‡Øç‡Æï‡Æ≥‡Øç ${INACTIVITY_MINUTES} ‡Æ®‡Æø‡ÆÆ‡Æø‡Æü‡Æô‡Øç‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Æ≤‡Øç‡Æ™‡Æü‡ÆÆ‡Ææ‡Æü‡Øç‡Æü‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Øç. ‡Æµ‡Æø‡Æ©‡Ææ‡Æü‡Æø-‡Æµ‡Æø‡Æ©‡Ææ ‡ÆÆ‡ØÅ‡Æü‡Æø‡Æµ‡Æü‡Øà‡Æï‡Æø‡Æ±‡Æ§‡ØÅ.`);
      if (typeof window.showResults === 'function') {
        window.showResults();
      } else if (typeof window.endQuiz === 'function') {
        window.endQuiz();
      } else {
        // fallback show custom results with zeros if possible
        if (typeof window.currentQuizData !== 'undefined') {
          saveQuizResult(window.currentQuizData.title || 'Unknown Quiz', 0, (window.currentQuizData.data.questions||[]).length || 0, 0);
        }
        // also dispatch event
        document.dispatchEvent(new CustomEvent('quiz-inactivity-timeout'));
      }
    }, INACTIVITY_MINUTES * 60 * 1000);
  }
  function stopInactivityTimer() {
    clearTimeout(inactivityTimer);
  }

  function startQuizTimer(questionCount) {
    stopTimer();
    resetInactivityTimer();
    const timerBox = document.getElementById('tv-timer-box');
    if (!timerBox) return;
    let totalMinutes = Math.max(1, Math.round(questionCount)); // simple default
    totalSeconds = totalMinutes * 60;
    timerBox.style.display = 'block';
    updateTimerDisplay();
    timerInterval = setInterval(() => {
      totalSeconds--;
      updateTimerDisplay();
      if (totalSeconds <= 0) {
        stopTimer();
        stopInactivityTimer();
        alert('‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç ‡ÆÆ‡ØÅ‡Æü‡Æø‡Æ®‡Øç‡Æ§‡Æ§‡ØÅ!');
        if (typeof window.showResults === 'function') window.showResults();
        else document.dispatchEvent(new CustomEvent('quiz-timeout'));
      }
    }, 1000);
  }
  function updateTimerDisplay() {
    const timerDisplay = document.getElementById('tv-timer-display');
    if (!timerDisplay) return;
    const minutes = Math.floor(totalSeconds / 60) || 0;
    const seconds = totalSeconds % 60 || 0;
    timerDisplay.textContent = `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
    if (totalSeconds <= 60) timerDisplay.classList.add('warning'); else timerDisplay.classList.remove('warning');
  }
  function stopTimer() {
    clearInterval(timerInterval);
    const timerDisplay = document.getElementById('tv-timer-display');
    if (timerDisplay) timerDisplay.classList.remove('warning');
  }

  // --- Event wiring ---

  // When user actually interacts anywhere in the document, reset inactivity timer
  ['click','keydown','touchstart'].forEach(ev => {
    document.addEventListener(ev, () => resetInactivityTimer(), { passive: true });
  });

  // When select changes load selected quiz
  quizSelect.addEventListener('change', handleQuizSelect);

  // Hook into external loader events:
  // If quiz-loader.js dispatches 'quiz-finished' with detail {score,total,title} we save it
  document.addEventListener('quiz-finished', (ev) => {
    const d = ev.detail || {};
    saveQuizResult(d.title || 'Quiz', d.score || 0, d.total || 0, d.percentage || 0);
  });

  // Also listen for global custom save requests
  document.addEventListener('save-quiz-result', (ev) => {
    const d = ev.detail || {};
    saveQuizResult(d.title, d.score, d.total, d.percentage);
  });

  // Login / logout wiring
  loginBtn.addEventListener('click', () => {
    const username = usernameInput.value.trim();
    if (!username) return alert('Please enter your name (‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øà ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç)');
    const userData = { name: username };
    localStorage.setItem('quizUser', JSON.stringify(userData));
    if (!localStorage.getItem('quizHistory')) localStorage.setItem('quizHistory', JSON.stringify([]));
    showApp();
  });

  logoutBtn.addEventListener('click', () => {
    if (confirm('‡Æµ‡ØÜ‡Æ≥‡Æø‡ÆØ‡Øá‡Æ± ‡Æµ‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡ØÅ‡Æï‡Æø‡Æ±‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Ææ? ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÜ‡Æ£‡Øç ‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡ØÅ ‡ÆÖ‡Æ©‡Øà‡Æ§‡Øç‡Æ§‡ØÅ‡ÆÆ‡Øç ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡ÆÆ‡Øç.')) {
      stopTimer();
      stopInactivityTimer();
      localStorage.removeItem('quizUser');
      localStorage.removeItem('quizHistory');
      window.location.reload();
    }
  });

  // If uploader code updates localStorage quiz list, auto-refresh select
  window.addEventListener('storage', (e) => {
    if (e.key === LOCAL_STORAGE_QUIZ_LIST) {
      try {
        const parsed = JSON.parse(e.newValue || '[]');
        populateQuizSelect(parsed);
      } catch (_) {}
    }
  });

  // Provide a simple public function to refresh quiz list on demand
  window.refreshQuizList = loadQuizList;

  // Init on DOM ready
  document.addEventListener('DOMContentLoaded', async () => {
    checkLogin();
    await loadQuizList();
    resetInactivityTimer();
  });

  // Expose saveQuizResult so external scripts can call it
  window._saveQuizResult = saveQuizResult;

})();
</script>
